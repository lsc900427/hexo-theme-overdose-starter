<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <style>

  </style>
</head>
<body>
<div id="test">test</div>

<script>
//const Style = (_=> {
//  const prop = new Map(); // runtime cache
//  const prefix = 'webkit, moz, ms, chrome, o, khtml'.split(',');
//  const NONE = {};
//  const getKey = k => {
//    let key = prop.get(k);
//    if(!key) {
//      const s = document.body.style;
//      console.log(k)
//      console.log(s)
//      if(k in s) prop.set(k, key = k);
//
//      else if(!prefix.some(v=> {
//        const newKey = v + k[0].toUpperCase() + k.substr(1);
//        if(newKey in s) return prop.set(k, key = newKey);
//          })) prop.set(k, key =NONE);
//    }
//};
//  return class {
//    constructor(style) {
//      this._style = style;
//    }
//    set(k, v) {
//      const key = getKey(k);
//      if(key !== NONE) this._style[key] = v;
//    }
//    get(k) {
//      const key = getKey(k);
//      return key === NONE ? null : this._style[key];
//    }
//  };
//})();
//
//const Rule = (_=> {
//  const trap = {
//    get(rule, key) {
//      return rule._style.get(key);
//    },
//    set(rule, key, val) {
//      rule._style.set(key, val);
//    }
//  };
//  return class {
//    constructor(rule) {
//      this._rule = rule;
//      this._style = new Style(rule, style);
//      return new Proxy(this, trap);
//    }
//  };
//})();


const Style =(_=>{
  const prop = new Map(); // runtime cache
const prefix = 'webkit,moz,ms,chrome,o,khtml'.split(',');
const NONE = {};
const getKey = k => {
  let key = prop.get(k);
  console.log(key)

  if(!key){
    const s = document.body.style;
    console.log(k)
    console.log(s)
    if(k in s) prop.set(k, key = k);
    else if(!prefix.some(v=>{
          const newKey = v + k[0].toUpperCase() + k.substr(1);
    if(newKey in s) return prop.set(k, key = newKey);
  })) prop.set(k, key = NONE);
  }
  console.log(key)

  return key;
};

return class{
  constructor(style){
    this._style = style;
  }
  set(k, v){
    console.log(k);
    console.log(v);
    const key = getKey(k);
    if(key !== NONE) this._style[key] = v;
  }
  get(k){
    const key = getKey(k);
    return key === NONE ? null : this._style[key];
  }
};
})();
// const test = new Style(document.getElementById('test').style);



const Rule =(_=>{
  const trap = {
    get(rule, key){return rule._style.get(key);},
    set(rule, key, val){rule._style.set(key, val);}
  };
return class{
  constructor(rule){
    this._rule = rule;
    this._style = new Style(rule.style);
    return new Proxy(this, trap);
  }
};
})();


const CSS = class {
  constructor(sheet) {
    this._sheet = sheet;
    this._rules = new WeakMap();
  }
  add(selector, index = -1) {
    const sheet = this._sheet, rules = sheet.cssRules;
    if(index == -1) index = rules.length;
    const rule = rules[sheet.insertRule(`${selector}{}`, index)];
    const ret = new Rule(rule);
    this._rules.set(rule, ret);
    return ret;
  }
}


const css = new CSS(document.styleSheets[0]);
const bodyRule = css.add('body');
bodyRule.background = 'red';


</script>
</body>
</html>